global
    log stdout format raw local0 info
    maxconn 4096

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    timeout connect 5s
    timeout client  50s
    timeout server  50s
    timeout tunnel  1h                  # 支持 WebSocket

# HTTP 入口：80 端口
frontend http-in
    bind *:80
    mode http

    # 统计页面
    stats uri /stats
    stats enable
    stats auth admin:admin888
    stats refresh 10s
    stats show-legends

    # ACL 规则（脚本 deploy.sh 会在此后插入新规则）
    acl is_default hdr(host) -i localhost

    # HTTP 到 HTTPS 跳转（脚本 deploy.sh 会在此后插入新规则）
    # http-request redirect scheme https code 301 if is_default

    default_backend nginx_backend

# HTTPS 入口：443 端口
frontend https-in
    bind *:443 ssl crt /etc/haproxy/certs/
    mode http

    # ACL 规则（脚本 deploy.sh 会在此后插入新规则）
    acl host_default hdr(host) -i localhost

    # 路由转发（脚本 deploy.sh 会在此后插入新规则）
    use_backend nginx_backend if host_default

    # 默认拒绝
    http-request deny if !host_default

# 默认后端 (Nginx)
backend nginx_backend
    balance roundrobin
    http-check connect
    http-check send meth HEAD uri / ver HTTP/1.1
    http-check expect rstatus (2|3)[0-9][0-9]

    # 保留原始 Host 头
    http-request set-header Host %[req.hdr(Host)]

    server nginx_srv nginx:8080 check inter 5s rise 2 fall 3
