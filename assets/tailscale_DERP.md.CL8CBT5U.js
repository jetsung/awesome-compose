import{_ as a,o as i,c as e,aj as l}from"./chunks/framework.DpVzuYkC.js";const E=JSON.parse('{"title":"","description":"","frontmatter":{},"headers":[],"relativePath":"tailscale/DERP.md","filePath":"tailscale/DERP.md"}'),t={name:"tailscale/DERP.md"};function n(h,s,p,r,k,o){return i(),e("div",null,[...s[0]||(s[0]=[l(`<h2 id="自定义-derp-服务器" tabindex="-1">自定义 DERP 服务器 <a class="header-anchor" href="#自定义-derp-服务器" aria-label="Permalink to “自定义 DERP 服务器”">​</a></h2><blockquote><p>此文档从<a href="https://tailscale.com/kb/1118/custom-derp-servers" target="_blank" rel="noreferrer"><strong>官方 DERP 文档</strong></a>提取并转为简体中文。</p></blockquote><h3 id="自定义-derp-服务器目前处于测试阶段" tabindex="-1">自定义 DERP 服务器目前处于测试阶段 <a class="header-anchor" href="#自定义-derp-服务器目前处于测试阶段" aria-label="Permalink to “自定义 DERP 服务器目前处于测试阶段”">​</a></h3><p>自定义 DERP 服务器是由组织或个人（而非 Tailscale）为特定网络需求设置和管理的指定 <a href="https://login.tailscale.com/kb/1232/derp-servers" target="_blank" rel="noreferrer">DERP 服务器</a>。默认情况下，所有 Tailscale 网络（称为 tailnet）都使用 Tailscale 运营的 DERP 服务器。DERP 服务器主要在促进 Tailscale 网络（称为 <a href="https://login.tailscale.com/kb/1136/tailnet" target="_blank" rel="noreferrer">tailnet</a>）中的设备之间的连接方面发挥支持作用。但当 <a href="https://login.tailscale.com/kb/1257/connection-types" target="_blank" rel="noreferrer">直接连接</a> 不可行且 <a href="https://login.tailscale.com/kb/1591/peer-relays" target="_blank" rel="noreferrer">对等中继</a> 不可用时，它们也可作为备用机制。</p><p>在大多数情况下，无需运行自定义 DERP 服务器。DERP 服务器通常仅充当 tailnet 中设备之间的连接纽带（无法查看设备之间交换的数据）。</p><p>但是，在一些限制较多的网络环境中，设备更有可能使用 DERP 服务器，因为它们无法与其他设备建立直接连接。由于 DERP 中继连接比直接连接慢，你可能会遇到性能不佳的情况。如果你经常遇到 DERP 中继连接，并且想避免性能问题，通常最好 <a href="https://login.tailscale.com/kb/1463/troubleshoot-connectivity" target="_blank" rel="noreferrer">找出无法建立直接连接的原因</a> 或设置对等中继，而不是使用自定义 DERP 服务器。</p><h4 id="tailscale-对等中继" tabindex="-1">Tailscale 对等中继 <a class="header-anchor" href="#tailscale-对等中继" aria-label="Permalink to “Tailscale 对等中继”">​</a></h4><ul><li>由于在你自己的网络或基础架构内运行，因此与 DERP 服务器相比，延迟更低，性能更好。</li><li>不会产生通过 DERP 服务器进行出口数据传输的额外成本（对于云环境）。</li><li>避免了维护自定义 DERP 服务器的开销和限制。</li></ul><p>也就是说，在某些罕见情况下，运行自定义 DERP 服务器可能是有意义的。例如，你可能运行自定义 DERP 服务器以 <a href="https://login.tailscale.com/kb/1167/release-stages#alpha" target="_blank" rel="noreferrer">限制加密流量的路由，以符合公司政策</a>。</p><h3 id="限制" tabindex="-1">限制 <a class="header-anchor" href="#限制" aria-label="Permalink to “限制”">​</a></h3><p>在大多数情况下，无需运行自定义 DERP 服务器。但是，在某些罕见情况下，运行自定义 DERP 服务器是有意义的。要这样做，你必须构建、部署和更新 <code>cmd/derper</code> 二进制文件。</p><p>运行自定义 DERP 服务器是一项高级操作，需要你投入大量资源来设置和维护。此外，运行自定义 DERP 服务器有以下注意事项：</p><ul><li>自定义 DERP 服务器不支持设备共享或其他跨 tailnet 功能。</li><li>与普通 DERP 服务器一样，自定义 DERP 服务器无法查看设备之间交换的数据，因为这些数据是加密的。因此，DERP 服务器对网络级调试没有帮助。</li><li>自定义 DERP 服务器无法从 Tailscale 控制平面的某些优化中受益。</li><li>自定义 DERP 服务器 <a href="https://login.tailscale.com/kb/1167/release-stages#direct-internet-access" target="_blank" rel="noreferrer">无法在防火墙或负载均衡器后面运行</a>。</li><li><a href="https://login.tailscale.com/kb/1258/mullvad-exit-nodes" target="_blank" rel="noreferrer">Mullvad 出口节点</a> 与自定义 DERP 服务器不兼容。</li><li>自定义 DERP 服务器不用于 <a href="https://login.tailscale.com/kb/1115/high-availability#regional-routing" target="_blank" rel="noreferrer">区域路由</a>。有关更新，请参阅 <a href="https://github.com/tailscale/tailscale/issues/12993" target="_blank" rel="noreferrer">问题 #12993</a>。</li></ul><h3 id="要求" tabindex="-1">要求 <a class="header-anchor" href="#要求" aria-label="Permalink to “要求”">​</a></h3><p>自定义 DERP 服务器必须 <a href="https://login.tailscale.com/kb/1167/release-stages#direct-internet-access" target="_blank" rel="noreferrer">直接访问互联网</a>、<a href="https://login.tailscale.com/kb/1167/release-stages#icmp-traffic" target="_blank" rel="noreferrer">允许 ICMP 流量</a> 并 <a href="https://login.tailscale.com/kb/1167/release-stages#required-ports" target="_blank" rel="noreferrer">为 HTTP、HTTPS 和 STUN 开放端口</a>。</p><h4 id="直接互联网访问" tabindex="-1">直接互联网访问 <a class="header-anchor" href="#直接互联网访问" aria-label="Permalink to “直接互联网访问”">​</a></h4><p>DERP 服务器需要直接的互联网连接，并且不得位于 NAT 设备（如防火墙）或负载均衡器后面。存在此直接连接要求有两个关键原因：<a href="https://login.tailscale.com/kb/1167/release-stages#device-identification" target="_blank" rel="noreferrer">设备识别</a> 和 <a href="https://login.tailscale.com/kb/1167/release-stages#protocol-compatibility" target="_blank" rel="noreferrer">协议兼容性</a>。</p><h5 id="设备识别" tabindex="-1">设备识别 <a class="header-anchor" href="#设备识别" aria-label="Permalink to “设备识别”">​</a></h5><p>DERP 服务器通过检查传入流量的源地址来识别 tailnet 设备。当流量通过 NAT 或负载均衡器时，此关键功能会失败，因为它们会修改原始源地址。</p><h5 id="协议兼容性" tabindex="-1">协议兼容性 <a class="header-anchor" href="#协议兼容性" aria-label="Permalink to “协议兼容性”">​</a></h5><p>Tailscale 客户端使用 HTTP 升级协议来建立双向数据通道。大多数云负载均衡器系统不支持此协议，因此与 DERP 服务器操作不兼容。</p><p>运行自己的 DERP 服务器是一项高级操作，需要你投入大量资源来设置和维护。</p><h4 id="所需端口" tabindex="-1">所需端口 <a class="header-anchor" href="#所需端口" aria-label="Permalink to “所需端口”">​</a></h4><p>DERP 服务器必须开放以下端口以运行 HTTP 服务器、HTTPS 服务器和 <a href="https://en.wikipedia.org/wiki/STUN" target="_blank" rel="noreferrer">STUN</a> 服务器。这三个服务的端口需要对互联网流量开放，以便你的 tailnet 中的用户可以从家中或咖啡店等地方访问它们。</p><table tabindex="0"><thead><tr><th>服务器</th><th>端口</th></tr></thead><tbody><tr><td>HTTP</td><td><code>80</code></td></tr><tr><td>HTTPS</td><td><code>443</code></td></tr><tr><td>STUN</td><td><code>3478</code></td></tr></tbody></table><p>要为 HTTPS 和 STUN 使用其他端口号，请分别设置 <a href="https://pkg.go.dev/tailscale.com/tailcfg#DERPNode.DERPPort" target="_blank" rel="noreferrer">DERPNode.DERPPort</a> 或 <a href="https://pkg.go.dev/tailscale.com/tailcfg#DERPNode.STUNPort" target="_blank" rel="noreferrer">DERPNode.STUNPort</a>。你不能为 HTTP 使用自定义端口号。</p><h4 id="icmp-流量" tabindex="-1">ICMP 流量 <a class="header-anchor" href="#icmp-流量" aria-label="Permalink to “ICMP 流量”">​</a></h4><p>DERP 服务器必须允许传入和传出的 ICMP（Internet 控制消息协议）流量。</p><p>Tailscale 运行 <a href="https://login.tailscale.com/kb/1232/derp-servers" target="_blank" rel="noreferrer">DERP 中继服务器</a> 来帮助连接你的节点。一般来说，你不需要自定义 Tailscale DERP 服务器。但是，这是可能的。</p><h3 id="开始使用自定义-derp-服务器" tabindex="-1">开始使用自定义 DERP 服务器 <a class="header-anchor" href="#开始使用自定义-derp-服务器" aria-label="Permalink to “开始使用自定义 DERP 服务器”">​</a></h3><p>运行自己的 DERP 服务器是一项高级操作，需要你投入大量资源来设置和维护。在继续之前，请考虑 <a href="https://login.tailscale.com/kb/1167/release-stages#requirements" target="_blank" rel="noreferrer">要求</a> 和 <a href="https://login.tailscale.com/kb/1167/release-stages#limitations" target="_blank" rel="noreferrer">限制</a>。</p><p>要设置自定义 DERP 服务器，你需要：</p><ol><li>从源代码运行 DERP 服务器。</li><li>将 DERP 服务器添加到你的 tailnet。</li></ol><p>以下其他步骤是可选的：</p><ol><li>限制 tailnet 设备对自定义 DERP 服务器的访问。</li><li>从你的 tailnet 中删除 Tailscale 的默认 DERP 服务器。</li></ol><h4 id="从源代码运行-derp-服务器" tabindex="-1">从源代码运行 DERP 服务器 <a class="header-anchor" href="#从源代码运行-derp-服务器" aria-label="Permalink to “从源代码运行 DERP 服务器”">​</a></h4><p>要运行自己的 DERP 服务器，你必须从源代码构建 DERP 服务器。使用 <a href="https://golang.org/doc/install" target="_blank" rel="noreferrer">最新版本的 Go</a>，运行：</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">go</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tailscale.com/cmd/derper@latest</span></span></code></pre></div><p>将最新的 DERP 服务器安装到 <code>$HOME/go/bin</code>。</p><p>在运行二进制文件之前，你需要一个指向你的服务器的域名。有了域名和二进制文件后，要在你的域名上启动 DERP 服务器，请运行：</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> derper</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --hostname=example.com</span></span></code></pre></div><p>这将在端口 443 上启动可通过你的域名访问的 DERP 服务器。然后，你可以按照步骤 2 中的说明将 DERP 服务器添加到你的 tailnet。</p><p>为了与 Tailscale 客户端更新保持兼容，你可能需要通过使用 <code>go install tailscale.com/cmd/derper@latest</code> 从源代码重新构建来定期更新 DERP 服务器。</p><h4 id="将自定义-derp-服务器添加到你的-tailnet" tabindex="-1">将自定义 DERP 服务器添加到你的 tailnet <a class="header-anchor" href="#将自定义-derp-服务器添加到你的-tailnet" aria-label="Permalink to “将自定义 DERP 服务器添加到你的 tailnet”">​</a></h4><p>如果你发现 Tailscale 在你所在的区域内没有提供 DERP 服务器，或者你因其他原因无法使用提供的 DERPs，你可以通过在你的 tailnet 的 <a href="https://login.tailscale.com/kb/1337/policy-syntax" target="_blank" rel="noreferrer">策略 JSON</a> 中指定它们来扩充或编辑 DERP 服务器集，方法是将 <code>derpMap</code> 键设置为 <a href="https://pkg.go.dev/tailscale.com/tailcfg#DERPMap" target="_blank" rel="noreferrer">DERPMap</a> 类型的值。</p><p>每个区域都有一个唯一的区域 ID。区域 ID 值 <code>900</code> 到 <code>999</code> 保留供自定义、用户指定的区域使用，Tailscale 不会使用。</p><p>例如，以下配置启用了一个主机名为 <code>example.com</code> 的自定义 DERP 服务器。有关更多选项，请参阅 <a href="https://pkg.go.dev/tailscale.com/tailcfg#DERPRegion" target="_blank" rel="noreferrer">DERPRegion</a> 和 <a href="https://pkg.go.dev/tailscale.com/tailcfg#DERPNode" target="_blank" rel="noreferrer">DERPNode</a> 的定义。</p><div class="language-json"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // ... tailnet 策略文件的其他部分</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;derpMap&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;Regions&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;900&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        &quot;RegionID&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">900</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        &quot;RegionCode&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;myderp&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        &quot;Nodes&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            &quot;Name&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;1&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            &quot;RegionID&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">900</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            &quot;HostName&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;example.com&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // IPv4 和 IPv6 是可选的，但建议使用，以减少</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // 如果 DNS 不可用或出现问题时潜在的 DERP 连接问题。</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // 地址必须是可公开路由的，且不在私有 IP 范围内。</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            &quot;IPv4&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;203.0.113.15&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            &quot;IPv6&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;2001:db8::1&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        ]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>每个区域只能有一个 DERP 服务器。如果你需要 DERP 冗余，请使用多个区域，每个区域只有一个 DERP 服务器。</p><h4 id="可选-删除-tailscale-的-derp-服务器" tabindex="-1">（可选）删除 Tailscale 的 DERP 服务器 <a class="header-anchor" href="#可选-删除-tailscale-的-derp-服务器" aria-label="Permalink to “（可选）删除 Tailscale 的 DERP 服务器”">​</a></h4><p>出于各种原因，例如 <a href="https://login.tailscale.com/kb/1167/release-stages#policy-compliance" target="_blank" rel="noreferrer">合规性</a>，你可能不希望通过特定的 DERP 区域路由流量。你可以通过在 tailnet 策略文件中创建自定义 DERP 地图来删除你的 tailnet 中的设备可用的 DERP 区域。要排除一个区域，将其值设置为 <code>null</code>。设置为 <code>null</code> 时，你的 tailnet 中的设备无法连接到该区域的 DERP 服务器。</p><p>例如，以下 DERP 地图配置禁用了通过纽约 Tailscale DERP 区域（区域 ID 为 <code>1</code>）的流量路由：</p><div class="language-json"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // ... tailnet 策略文件的其他部分</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;derpMap&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;Regions&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;1&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> } }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>你可以从 <code>https://controlplane.tailscale.com/derpmap/default</code> 访问 Tailscale 的默认 DERP 地图：</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://controlplane.tailscale.com/derpmap/default</span></span></code></pre></div><p>如果你安装了 <code>jq</code>，可以使用以下命令列出 Tailscale 的默认 DERP 区域及其 ID：</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --silent</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://controlplane.tailscale.com/derpmap/default</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> jq</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -r</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;.Regions[] | &quot;\\(.RegionID) \\(.RegionName)&quot;&#39;</span></span></code></pre></div><p>要确保你的流量仅通过自定义 DERP 服务器流动，请通过在 DERP 地图中将 <code>OmitDefaultRegions</code> 标志设置为 <code>true</code> 来删除所有 Tailscale 的默认 DERP 区域：</p><div class="language-json"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // ... tailnet 策略文件的其他部分</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;derpMap&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;OmitDefaultRegions&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    &quot;Regions&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      &quot;900&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        &quot;RegionID&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">900</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        &quot;RegionCode&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;myderp&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        &quot;Nodes&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            &quot;Name&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;1&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            &quot;RegionID&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">900</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            &quot;HostName&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;example.com&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // IPv4 和 IPv6 是可选的，但建议使用，以减少</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // 如果 DNS 不可用或出现问题时潜在的 DERP 连接问题。</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // 地址必须是可公开路由的，且不在私有 IP 范围内。</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            &quot;IPv4&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;203.0.113.15&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            &quot;IPv6&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;2001:db8::1&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        ]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>你可以在源代码的 <a href="https://pkg.go.dev/tailscale.com/tailcfg#DERPMap" target="_blank" rel="noreferrer">DERPMap 定义</a> 中访问 DERP 地图的完整选项集。</p><h4 id="可选-验证到自定义-derp-服务器的客户端流量" tabindex="-1">（可选）验证到自定义 DERP 服务器的客户端流量 <a class="header-anchor" href="#可选-验证到自定义-derp-服务器的客户端流量" aria-label="Permalink to “（可选）验证到自定义 DERP 服务器的客户端流量”">​</a></h4><p>任何知道你的 DERP 服务器 IP 地址的人都可以将其添加到他们的 DERP 地图中，并通过你的 DERP 服务器路由他们的 tailnet 流量。要仅允许你的 tailnet 流量通过你的 DERP 服务器，在与你的 DERP 服务器相同的设备上运行 <code>tailscaled</code>，并使用 <code>--verify-clients</code> 标志启动 <code>derper</code>：</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> derper</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --hostname=example.com</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --verify-clients</span></span></code></pre></div><h3 id="监控自定义-derp-服务器" tabindex="-1">监控自定义 DERP 服务器 <a class="header-anchor" href="#监控自定义-derp-服务器" aria-label="Permalink to “监控自定义 DERP 服务器”">​</a></h3><p>使用 <a href="https://github.com/tailscale/tailscale/tree/main/cmd/derpprobe" target="_blank" rel="noreferrer">cmd/derpprobe</a> 二进制文件监控你的自定义 DERP 服务器，并验证它们是否正常工作。你需要指定一个 <code>--derp-map=file://</code> URL，该 URL 是一个包含要监控的 DERP 地图的 JSON 文档。</p><h3 id="策略合规性" tabindex="-1">策略合规性 <a class="header-anchor" href="#策略合规性" aria-label="Permalink to “策略合规性”">​</a></h3><p>托管自定义 DERP 服务器的一个原因是确保策略合规性。例如，你可能有严格的策略要求，防止流量通过公共服务器，即使流量是加密的。</p><p>DERP 服务器仅转发加密流量，并且它们无法访问明文流量。此外，Tailscale 的 DERP 服务器是所有 Tailscale 客户共享的资源。你可能有严格的路由策略，例如防止加密流量穿过你无法控制的服务器。</p><p>为了符合此类策略，你可以运行一个或多个自定义 DERP 服务器，并从你的 tailnet 可以使用的 DERP 服务器列表中删除默认的 Tailscale DERP 服务器。</p>`,69)])])}const c=a(t,[["render",n]]);export{E as __pageData,c as default};
